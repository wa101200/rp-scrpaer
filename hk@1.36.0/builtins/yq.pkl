import "../Builtins.pkl"
import "../Config.pkl"
import "./test/helpers.pkl"

@Builtins.meta {
  category = "Data Formats"
  description = "YAML processor"
}
yq = new Config.Step {
  glob = List("**/*.yaml", "**/*.yml")
  check_diff =
    """
    failed=0
    for f in {{ files }}; do
      yq -P "$f" | diff -u "$f" - || failed=1
    done
    exit $failed
    """
  fix = "yq -iP {{ files }}"
  tests {
    local const testMaker = new helpers.TestMaker { filename = "test.yaml" }
    ["check bad file"] = testMaker.checkFail("foo:  bar", 1)
    ["check good file"] = testMaker.checkPass("foo: bar\n")
    ["fix bad file"] = testMaker.fixPass("foo:  bar", "foo: bar\n")
    ["fix good file"] = testMaker.fixPass("foo: bar\n", "foo: bar\n")
  }
}
