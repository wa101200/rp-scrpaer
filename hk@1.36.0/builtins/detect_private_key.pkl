import "../Builtins.pkl"
import "../Config.pkl"
import "./test/helpers.pkl"

@Builtins.meta {
  category = "Special Purpose"
  description = "Detect accidentally committed private keys"
}
detect_private_key = new Config.Step {
  glob = "**/*"
  check = "hk util detect-private-key {{files}}"
  tests {
    local const testMaker = new helpers.TestMaker {}
    ["check RSA private key"] =
      testMaker.checkFail(
        """
        -----BEGIN RSA PRIVATE KEY-----
        MIIEpAIBAAKCAQEA...
        -----END RSA PRIVATE KEY-----
        """,
        1,
      )
    ["check OpenSSH private key"] =
      testMaker.checkFail(
        """
        -----BEGIN OPENSSH PRIVATE KEY-----
        b3BlbnNzaC1rZXktdjEAAAAABG5vbmU...
        -----END OPENSSH PRIVATE KEY-----
        """,
        1,
      )
    ["check public key"] =
      testMaker.checkPass("ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC... user@host")
    ["check clean file"] = testMaker.checkPass("Hello, world!")
  }
}
